<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>КИ Лахта Центр - Аналитическая панель</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .kpi-card {
            transition: all 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .source-filter-btn, .org-filter-btn, .stage-filter-btn {
            transition: all 0.2s ease;
        }
        .source-filter-btn.active, .org-filter-btn.active, .stage-filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-6">
        <!-- Header -->
        <div class="max-w-7xl mx-auto mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">КИ Лахта Центр</h1>
            <p class="text-gray-600">Аналитическая панель по замечаниям</p>
        </div>

        <!-- File Upload -->
        <div class="max-w-7xl mx-auto mb-8">
            <div class="bg-white rounded-2xl shadow-md p-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Загрузить Excel файл</label>
                <input type="file" id="fileInput" accept=".xlsx,.xls" 
                       class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                <p class="mt-2 text-xs text-gray-500">Поддерживаемые листы: КИ Башня, КИ МФЗ, Общие замечания 2025</p>
            </div>
        </div>

        <!-- Filters -->
        <div class="max-w-7xl mx-auto mb-8">
            <div class="bg-white rounded-2xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Фильтры</h2>
                
                <!-- Source Filter -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-700 mb-3">Источник данных</h3>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="setSourceFilter('all')" class="source-filter-btn active px-6 py-3 rounded-xl bg-gray-100 text-gray-700 font-medium">
                            Все
                        </button>
                        <button onclick="setSourceFilter('tower')" class="source-filter-btn px-6 py-3 rounded-xl bg-gray-100 text-gray-700 font-medium">
                            Башня
                        </button>
                        <button onclick="setSourceFilter('mfz')" class="source-filter-btn px-6 py-3 rounded-xl bg-gray-100 text-gray-700 font-medium">
                            МФЗ
                        </button>
                        <button onclick="setSourceFilter('general')" class="source-filter-btn px-6 py-3 rounded-xl bg-gray-100 text-gray-700 font-medium">
                            Общие
                        </button>
                    </div>
                </div>

                <!-- Organization Filter -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-700 mb-3">Ответственная организация</h3>
                    <div id="organizationFilters" class="flex flex-wrap gap-3">
                        <button onclick="setOrganizationFilter('all')" class="org-filter-btn active px-4 py-2 rounded-lg bg-gray-100 text-gray-700 text-sm font-medium">
                            Все
                        </button>
                    </div>
                </div>

                <!-- Stage Filter -->
                <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-3">Этап</h3>
                    <div id="stageFilters" class="flex flex-wrap gap-3">
                        <button onclick="setStageFilter('all')" class="stage-filter-btn active px-4 py-2 rounded-lg bg-gray-100 text-gray-700 text-sm font-medium">
                            Все
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="max-w-7xl mx-auto mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Total Count -->
                <div class="kpi-card bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg p-6 text-white">
                    <h3 class="text-sm font-medium opacity-90 mb-2">Общее количество</h3>
                    <p class="text-4xl font-bold" id="kpi-total">0</p>
                </div>

                <!-- Accepted -->
                <div class="kpi-card bg-gradient-to-br from-green-500 to-green-600 rounded-2xl shadow-lg p-6 text-white">
                    <h3 class="text-sm font-medium opacity-90 mb-2">Принято в работу</h3>
                    <p class="text-4xl font-bold" id="kpi-accepted">0</p>
                </div>

                <!-- Not Accepted -->
                <div class="kpi-card bg-gradient-to-br from-red-500 to-red-600 rounded-2xl shadow-lg p-6 text-white">
                    <h3 class="text-sm font-medium opacity-90 mb-2">Не принято</h3>
                    <p class="text-4xl font-bold" id="kpi-rejected">0</p>
                </div>

                <!-- Requires Clarification -->
                <div class="kpi-card bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-2xl shadow-lg p-6 text-white">
                    <h3 class="text-sm font-medium opacity-90 mb-2">Требует уточнения</h3>
                    <p class="text-4xl font-bold" id="kpi-clarification">0</p>
                </div>

                <!-- Warranty -->
                <div class="kpi-card bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl shadow-lg p-6 text-white">
                    <h3 class="text-sm font-medium opacity-90 mb-2">Гарантийных (из принятых)</h3>
                    <p class="text-4xl font-bold" id="kpi-warranty">0</p>
                </div>

                <!-- Resolved -->
                <div class="kpi-card bg-gradient-to-br from-teal-500 to-teal-600 rounded-2xl shadow-lg p-6 text-white">
                    <h3 class="text-sm font-medium opacity-90 mb-2">Устранено</h3>
                    <p class="text-4xl font-bold" id="kpi-resolved">0</p>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="max-w-7xl mx-auto space-y-8">
            <!-- Plan Chart -->
            <div class="bg-white rounded-2xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">План устранения принятых</h2>
                <div class="chart-container">
                    <canvas id="planChart"></canvas>
                </div>
            </div>

            <!-- Contractors Chart -->
            <div class="bg-white rounded-2xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Замечания по подрядчикам</h2>
                <div class="chart-container">
                    <canvas id="contractorsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = {
            tower: [],
            mfz: [],
            general: []
        };
        let currentFilter = {
            source: 'all',
            organization: 'all',
            stage: 'all'
        };
        let availableOrganizations = new Set();
        let availableStages = new Set();
        let planChart = null;
        let contractorsChart = null;

        // Helper function to find column by partial name (case-insensitive, handles line breaks)
        function findColumn(row, keywords) {
            for (let key in row) {
                const cleanKey = key.replace(/\n/g, ' ').toLowerCase();
                if (keywords.some(kw => cleanKey.includes(kw.toLowerCase()))) {
                    return row[key];
                }
            }
            return null;
        }

        // Helper function to normalize column name
        function normalizeColumnName(name) {
            return name.replace(/\n/g, ' ').trim();
        }

        // Parse Excel date
        function parseExcelDate(value) {
            if (!value) return null;
            if (value instanceof Date) return value;
            if (typeof value === 'number') {
                // Excel date serial number
                const date = new Date((value - 25569) * 86400 * 1000);
                return date;
            }
            if (typeof value === 'string') {
                const date = new Date(value);
                return isNaN(date) ? null : date;
            }
            return null;
        }

        // Format date for display
        function formatDate(date) {
            if (!date) return null;
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        // Process data from a sheet
        function processSheet(data, sheetName) {
            const processed = [];
            
            data.forEach(row => {
                // Find columns using flexible matching
                const status = findColumn(row, ['Синергия', 'Принято/Не принято', 'Принято']);
                const eliminationStatus = findColumn(row, ['Статус устранения', 'Подрядчиком']);
                const warranty = findColumn(row, ['Гарантия']);
                const organization = findColumn(row, ['Ответственная', 'Организация']);
                const planDate = findColumn(row, ['Дата устранения', 'план']);
                const actualDate = findColumn(row, ['Фактическая', 'дата', 'устранения']);
                const presentedDate = findColumn(row, ['Предъявлено', 'ФУСЗ']);
                const stage = findColumn(row, ['Этап']);

                const item = {
                    sheet: sheetName,
                    status: status ? String(status).trim() : null,
                    eliminationStatus: eliminationStatus ? String(eliminationStatus).trim() : null,
                    warranty: warranty ? String(warranty).trim() : null,
                    organization: organization ? String(organization).trim() : null,
                    stage: stage ? String(stage).trim() : null,
                    planDate: parseExcelDate(planDate),
                    actualDate: parseExcelDate(actualDate),
                    presentedDate: parseExcelDate(presentedDate)
                };

                // Auto-fill logic: if status is "Устранено" but no actual date, consider it resolved between 12.01.2025 and today
                if (item.eliminationStatus === 'Устранено' && !item.actualDate) {
                    item.actualDate = new Date('2025-01-20'); // Mid-point for visualization
                }

                // Track unique organizations and stages
                if (item.organization) {
                    availableOrganizations.add(item.organization);
                }
                if (item.stage) {
                    availableStages.add(item.stage);
                }

                processed.push(item);
            });

            return processed;
        }

        // Load and process file
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});

                // Reset filters and collections
                availableOrganizations.clear();
                availableStages.clear();
                currentFilter = {
                    source: 'all',
                    organization: 'all',
                    stage: 'all'
                };

                // Process each sheet
                const sheetMap = {
                    'КИ Башня': 'tower',
                    'КИ МФЗ': 'mfz',
                    'Общие замечания 2025': 'general'
                };

                for (let sheetName in sheetMap) {
                    if (workbook.SheetNames.includes(sheetName)) {
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        allData[sheetMap[sheetName]] = processSheet(jsonData, sheetMap[sheetName]);
                    }
                }

                // Build filter buttons
                buildOrganizationFilters();
                buildStageFilters();

                // Update dashboard
                updateDashboard();
            };
            reader.readAsArrayBuffer(file);
        });

        // Build organization filter buttons
        function buildOrganizationFilters() {
            const container = document.getElementById('organizationFilters');
            const sortedOrgs = Array.from(availableOrganizations).sort();
            
            container.innerHTML = `
                <button onclick="setOrganizationFilter('all')" class="org-filter-btn active px-4 py-2 rounded-lg bg-gray-100 text-gray-700 text-sm font-medium">
                    Все
                </button>
            `;
            
            sortedOrgs.forEach(org => {
                const btn = document.createElement('button');
                btn.className = 'org-filter-btn px-4 py-2 rounded-lg bg-gray-100 text-gray-700 text-sm font-medium';
                btn.textContent = org;
                btn.onclick = () => setOrganizationFilter(org);
                container.appendChild(btn);
            });
        }

        // Build stage filter buttons
        function buildStageFilters() {
            const container = document.getElementById('stageFilters');
            const sortedStages = Array.from(availableStages).sort((a, b) => {
                // Try to sort numerically if possible
                const numA = parseFloat(a);
                const numB = parseFloat(b);
                if (!isNaN(numA) && !isNaN(numB)) {
                    return numA - numB;
                }
                return a.localeCompare(b);
            });
            
            container.innerHTML = `
                <button onclick="setStageFilter('all')" class="stage-filter-btn active px-4 py-2 rounded-lg bg-gray-100 text-gray-700 text-sm font-medium">
                    Все
                </button>
            `;
            
            sortedStages.forEach(stage => {
                const btn = document.createElement('button');
                btn.className = 'stage-filter-btn px-4 py-2 rounded-lg bg-gray-100 text-gray-700 text-sm font-medium';
                btn.textContent = stage;
                btn.onclick = () => setStageFilter(stage);
                container.appendChild(btn);
            });
        }

        // Set source filter
        function setSourceFilter(filter) {
            currentFilter.source = filter;
            
            // Update button states
            document.querySelectorAll('.source-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateDashboard();
        }

        // Set organization filter
        function setOrganizationFilter(filter) {
            currentFilter.organization = filter;
            
            // Update button states
            document.querySelectorAll('.org-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateDashboard();
        }

        // Set stage filter
        function setStageFilter(filter) {
            currentFilter.stage = filter;
            
            // Update button states
            document.querySelectorAll('.stage-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateDashboard();
        }

        // Get filtered data
        function getFilteredData() {
            let data = [];
            
            // Filter by source
            if (currentFilter.source === 'all') {
                data = [...allData.tower, ...allData.mfz, ...allData.general];
            } else if (currentFilter.source === 'tower') {
                data = allData.tower;
            } else if (currentFilter.source === 'mfz') {
                data = allData.mfz;
            } else if (currentFilter.source === 'general') {
                data = allData.general;
            }
            
            // Filter by organization
            if (currentFilter.organization !== 'all') {
                data = data.filter(item => item.organization === currentFilter.organization);
            }
            
            // Filter by stage
            if (currentFilter.stage !== 'all') {
                data = data.filter(item => item.stage === currentFilter.stage);
            }
            
            return data;
        }

        // Update KPIs
        function updateKPIs(data) {
            const total = data.length;
            const accepted = data.filter(item => item.status === 'Принято').length;
            const rejected = data.filter(item => item.status === 'Не принято').length;
            const clarification = data.filter(item => item.status === 'Требует уточнения').length;
            const warranty = data.filter(item => item.status === 'Принято' && item.warranty === 'Да').length;
            const resolved = data.filter(item => item.eliminationStatus === 'Устранено').length;

            document.getElementById('kpi-total').textContent = total;
            document.getElementById('kpi-accepted').textContent = accepted;
            document.getElementById('kpi-rejected').textContent = rejected;
            document.getElementById('kpi-clarification').textContent = clarification;
            document.getElementById('kpi-warranty').textContent = warranty;
            document.getElementById('kpi-resolved').textContent = resolved;
        }

        // Update plan chart
        function updatePlanChart(data) {
            const accepted = data.filter(item => item.status === 'Принято');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Group by plan date
            const dateGroups = {};
            accepted.forEach(item => {
                if (item.planDate) {
                    const dateStr = formatDate(item.planDate);
                    if (!dateGroups[dateStr]) {
                        dateGroups[dateStr] = 0;
                    }
                    dateGroups[dateStr]++;
                }
            });

            // Sort dates
            const sortedDates = Object.keys(dateGroups).sort();
            const counts = sortedDates.map(date => dateGroups[date]);
            
            // Determine colors (green for past/today, yellow for future)
            const colors = sortedDates.map(dateStr => {
                const date = new Date(dateStr);
                return date <= today ? '#10b981' : '#fbbf24';
            });

            const ctx = document.getElementById('planChart');
            if (planChart) {
                planChart.destroy();
            }

            planChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Количество замечаний',
                        data: counts,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Замечаний: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Update contractors chart
        function updateContractorsChart(data) {
            const accepted = data.filter(item => item.status === 'Принято');

            // Group by organization
            const orgGroups = {};
            accepted.forEach(item => {
                if (item.organization) {
                    if (!orgGroups[item.organization]) {
                        orgGroups[item.organization] = { resolved: 0, unresolved: 0 };
                    }
                    if (item.eliminationStatus === 'Устранено') {
                        orgGroups[item.organization].resolved++;
                    } else {
                        orgGroups[item.organization].unresolved++;
                    }
                }
            });

            // Sort by total count
            const sortedOrgs = Object.keys(orgGroups).sort((a, b) => {
                const totalA = orgGroups[a].resolved + orgGroups[a].unresolved;
                const totalB = orgGroups[b].resolved + orgGroups[b].unresolved;
                return totalB - totalA;
            });

            const resolved = sortedOrgs.map(org => orgGroups[org].resolved);
            const unresolved = sortedOrgs.map(org => orgGroups[org].unresolved);

            const ctx = document.getElementById('contractorsChart');
            if (contractorsChart) {
                contractorsChart.destroy();
            }

            contractorsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedOrgs,
                    datasets: [
                        {
                            label: 'Устранено',
                            data: resolved,
                            backgroundColor: '#10b981',
                            borderColor: '#10b981',
                            borderWidth: 1
                        },
                        {
                            label: 'Не устранено',
                            data: unresolved,
                            backgroundColor: '#fbbf24',
                            borderColor: '#fbbf24',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.x}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        y: {
                            stacked: true
                        }
                    }
                }
            });
        }

        // Update entire dashboard
        function updateDashboard() {
            const data = getFilteredData();
            updateKPIs(data);
            updatePlanChart(data);
            updateContractorsChart(data);
        }

        // Initialize with empty state
        updateDashboard();
    </script>
</body>
</html>
